
## å•é¡Œ 13.2 ðŸ–‹ï¸

ä»¥ä¸‹ã®å„é–¢æ•° `f3` ã‹ã‚‰ `f12` ã¾ã§ã‚’å®Ÿè¡Œã™ã‚‹ã¨ä½•ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã‹äºˆæƒ³ã—å®Ÿéš›ã«ç¢ºèªã—ãªã•ã„ã€‚
ã¾ãŸãã®ç†ç”±ã‚’ 2ã€3 è¡Œã®ãƒ†ã‚­ã‚¹ãƒˆã€å›³ã®ã„ãšã‚Œã‹ã¾ãŸã¯ä¸¡æ–¹ã§èª¬æ˜Žã—ãªã•ã„ã€‚ãƒ†ã‚­ã‚¹ãƒˆãƒ»å›³ã¯ f1 ã®è§£ç­”ä¾‹ã‚’å‚è€ƒã«ã—ãªã•ã„ã€‚

```js
function f1() {
  // NOTE: f2 ã¨ã®æ¯”è¼ƒç”¨ (æ³¨: () => wait(...) ã¯ () => { return wait(...); } ã¨åŒã˜ã“ã¨ã«æ³¨æ„
  //
  // å›žç­”:
  // 3ç§’å¾Œã« A ãŒå‡ºåŠ›ã•ã‚Œã€ãã®2ç§’å¾Œã« B ãŒå‡ºåŠ›ã•ã‚Œã€ãã®1ç§’å¾Œã« C ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã€‚
  //
  // èª¬æ˜Ž:
  // wait3 ã®è§£æ±ºå¾Œã« logA ãŒå®Ÿè¡Œã•ã‚Œã€wait2().then(logB) ã®è§£æ±ºå¾Œ (2ç§’å¾Œã« B å‡ºåŠ›) ã« wait1().then(logC) ãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€‚
  //
  // å›³è§£:
  //  wait3
  // |---------------|
  //                  logA
  //                 |-|
  //                    wait2
  //                   |----------|
  //                               logB
  //                              |-|
  //                                 wait1
  //                                |-----|
  //                                       logC
  //                                      |-|
  wait3()
    .then(logA)
    .then(() => wait2().then(logB))
    .then(() => wait1().then(logC));
}

function f2() {
  // NOTE: 2ã¤ç›®ã® then ã®ä¸­ã§ return ãŒç„¡ããªã£ã¦ã„ã‚‹ã“ã¨ã«æ³¨æ„ (å…¸åž‹çš„ãªãƒŸã‚¹)
  //
  // è§£ç­”ä¾‹:
  // 3ç§’å¾Œã« A ãŒå‡ºåŠ›ã•ã‚Œã€ãã®1ç§’å¾Œã« C ãŒå‡ºåŠ›ã•ã‚Œã€ãã®1ç§’å¾Œã« B ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã€‚
  // 2ã¤ç›®ã® .then ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ãŒå€¤ã‚’ return ã—ã¦ã„ãªã„ãŸã‚ã€ã“ã® .then ãŒè¿”ã™ Promise ã¯å³è§£æ±ºã•ã‚Œã‚‹ã€‚
  // ã“ã®ãŸã‚ logA() ã®å®Ÿè¡Œã™ãå¾Œã« wait1().then(...) ãŒå®Ÿè¡Œã•ã‚Œ C ãŒå…ˆã«å‡ºåŠ›ã•ã‚Œã‚‹ã€‚
  //
  // å›³è§£:
  //  wait3
  // |---------------|
  //                  logA
  //                 |-|
  //                    wait2
  //                   |----------|
  //                               logB
  //                              |-|
  //                  wait1
  //                 |-----|
  //                        logC
  //                       |-|
  wait3()
    .then(logA)
    .then(() => {
      wait2().then(logB);
    })
    .then(() => wait1().then(logC));
}

function f3() {
  // NOTE: then ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å†…ã®ä¾‹å¤–ã¯ try/catch ã§ã‚­ãƒ£ãƒƒãƒã§ãã‚‹ã ã‚ã†ã‹
  // èª¬æ˜Žï¼š
  // Cå‡ºåŠ›ã€0ç§’å¾Œã«Aå‡ºåŠ›ã€Xã®throwã§ã‚¨ãƒ©ãƒ¼
  // 
  // tryé–‹å§‹ã€‚
  // æœ¬æ¥ã¯tryã€catchã€finallyã¯åŒæœŸã—ã¦ã„ã‚‹ã®ã§é †ã«å‹•ããŒwait(0).then(logA).then(errX) ãŒéžåŒæœŸå‡¦ç†
  // éžåŒæœŸã®å ´åˆã¯ç¾åœ¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡ŒãŒå®Œäº†ã—ãŸå¾Œã«å®Ÿè¡Œã¨ãªã‚‹ã€‚
  // wait(0)ã§0ç§’å¾…æ©Ÿå¾Œè§£æ±º
  // éžåŒæœŸå‡¦ç†ã®é–‹å§‹å¾Œã€finallyã‚’å®Ÿè¡Œã§ C ã‚’å‡ºåŠ›
  // ãƒ—ãƒ­ãƒŸã‚¹ã‚’è§£æ±ºå¾ŒerrXã‚’å®Ÿè¡Œã—ã‚¹ãƒ­ãƒ¼ã—ã¦catchã¸
  // then(errX)å®Ÿè¡Œã€catchã¸ã‚¹ãƒ­ãƒ¼ã—Xã‚’æ¸¡ã™ã€‚
  // æ¸¡ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆXã‚’è¡¨ç¤º
  // 
  // å›³è§£:
  // try
  //   wait(0)
  //   |------|
  //     .then(logA)
  //     |-----|
  //           rogA 
  //ã€€ã€€ã€€     |-|
  //           .then(errX) 
  //ã€€ã€€ã€€     |-|
  //           throw Error(X) 
  //ã€€ã€€ã€€     |-|
  // catch.then
  // |-----------| 
  //             (errX)(æœªã‚­ãƒ£ãƒƒãƒã®ã‚¨ãƒ©ãƒ¼)
  //             |-|
  // finally
  // |-|
  //   logC
  //   |-|
  try {
    wait(0).then(logA).then(errX);
  } catch (e) {
    logB();
  } finally {
    logC();
  }
}

function f4() {
  // NOTE: f5 ã¨ã®æ¯”è¼ƒç”¨
  // 
  // è§£ç­”:
  // 2ç§’å¾Œã« A ãŒå‡ºåŠ›ã•ã‚Œã€ãã®1ç§’å¾Œã« B ãŒå‡ºåŠ›ã•ã‚Œã€ãã®å¾Œ 100 ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã€‚
  // 
  // èª¬æ˜Žï¼š
  // wait2 ã®è§£æ±ºå¾Œã« logA ãŒå®Ÿè¡Œã•ã‚Œã€ãã®å¾Œ1ç§’å¾Œã« logB ãŒå®Ÿè¡Œã•ã‚Œ 100 ã‚’è¿”ã—ã€æ¬¡ã® .then ã§ 100 ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã€‚
  // 
  // å›³è§£:
  //  wait2
  // |----------|
  //            logA
  //            |-|
  //              wait(1000)
  //              |----------|
  //                         logB
  //                         |-|
  //                           logV
  //ã€€                         |-|  wait2()
  wait2()
    .then(() => {
      logA();
      return 40;
    })
    .then((value) =>
      wait(1000).then(() => {
        logB();
        return 100;
      })
    )
    .then((v) => log(v));
}

function f5() {
  // NOTE: 2ã¤ç›®ã® then ã®å¼•æ•°ãŒé–¢æ•°ã§ãªã Promise ã«ãªã£ã¦ã„ã‚‹ (å…¸åž‹çš„ãªãƒŸã‚¹)
  // 
  // è§£ç­”:
  // 1ç§’å¾Œã« B ãŒå‡ºåŠ›ã•ã‚Œã€ãã®2ç§’å¾Œã« A ãŒå‡ºåŠ›ã•ã‚Œã€ãã®å¾Œ 40 ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã€‚
  // 
  // èª¬æ˜Žï¼š
  // wait2 ã®è§£æ±ºå¾Œã«ä¸€ã¤ç›®ã®.thenã‚ˆã‚Š logA ãŒå®Ÿè¡Œã•ã‚Œ40ã‚’è¿”ã™ã€‚
  // æ¬¡ã®.thenã«ã¯é–¢æ•°ã§ã¯ãªãpromise wait1().then(() => {logB();return 100;})ã€€ãŒæ¸¡ã•ã‚Œã‚‹ãŸã‚ã€ä¸€ã¤ç›®ã®thenã¯å¾…ãŸãªã„ãšã€æ¬¡ã®thenã«å¼•ç¶™ãŽã‚‚ã•ã‚Œãªã„
  // wait1() ã§1ç§’å¾Œã« logB ãŒå®Ÿè¡Œã•ã‚Œ 100 ã‚’è¿”ã—ã€ä¸€ã¤ç›®ã® .then ã®retrunã‚’å¼•ç¶™ãŽ 40 ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã€‚
  // 
  // å›³è§£:
  //  wait2
  // |----------|
  //            logA(40)
  //            |-|
  // wait(1000)
  // |-----|
  //       logB
  //       |-|
  //              logV
  //ã€€            |-|  wait2()
    .then(() => {
      logA();
      return 40;
    })
    .then(
      wait1().then(() => {
        logB();
        return 100;
      })
    )
    .then((v) => log(v));
}

function f6() {
  // NOTE: 1ã¤ã® Promise ã«å¯¾ã— then ã‚’2å›žå‘¼ã³å‡ºã™ã¨ã©ã†ãªã‚‹ã‹
  // è§£ç­”:
  // 1ç§’å¾Œã« A ãŒå‡ºåŠ›ã•ã‚Œã€AãŒå‡ºåŠ›ã—ãŸ1ç§’å¾Œã« B ãŒå‡ºåŠ›ã•ã‚Œã€AãŒå‡ºåŠ›ã—ãŸ2ç§’å¾Œã« C ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã€‚
  // 
  // èª¬æ˜Žï¼š
  // wait1 ã®è§£æ±ºå¾Œã«ä¸€ã¤ç›®ã®.thenã‚ˆã‚Š logA ãŒå®Ÿè¡Œã€‚
  // logAå®Ÿè¡Œå¾Œã«p.thenã®wait1()ã¨ wait2()ãŒéžåŒæœŸã®ç‚ºåŒæ™‚ã«å¾…æ©Ÿã€‚logAå®Ÿè¡Œå¾Œ1ç§’å¾Œã«wait1ã®å¾…æ©ŸãŒçµ‚ã‚ã‚ŠlogBã‚’å®Ÿè¡Œã€
  // logAå®Ÿè¡Œå¾Œ2ç§’å¾Œã«logCå®Ÿè¡Œ
  // 
  // å›³è§£:
  //  wait1
  // |-----|
  //       logA
  //       |-|
  //          wait1
  //          |-----|
  //                logB
  //                |-|
  //          wait2
  //          |----------|
  //      ã€€ã€€ã€€          logC
  //ã€€ã€€ã€€                |-|
  const p = wait1().then(logA);
  p.then(() => wait1()).then(logB);
  p.then(() => wait2()).then(logC);
}

function f7() {
  // NOTE: 2ã¤ç›®ã® wait ã®å¼•æ•°ãŒå®Ÿè¡Œã•ã‚Œã‚‹å·®ã«ã¯ p ã¯è§£æ±ºæ¸ˆã¿
  // (= è§£æ±ºæ¸ˆã¿ã® Promise ã® then ã‚’å‘¼ã³å‡ºã™ã¨ã©ã†ãªã‚‹ã‹)
  // è§£ç­”:
  // 1ç§’å¾Œã« A ãŒå‡ºåŠ›ã•ã‚Œã€wait1ãŒè§£æ±ºã—ãŸ2ç§’å¾Œã« B ãŒå‡ºåŠ›ã•ã‚Œã€C ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã€‚
  // èª¬æ˜Žï¼š
  // wait1 ã§1ç§’å¾…æ©Ÿã€è§£æ±ºå¾Œã« logAå®Ÿè¡Œ ã¨ wait2 ã§2ç§’å¾…æ©Ÿ
  // wait2 2ç§’å¾…æ©Ÿå¾Œã«pã¯è§£æ±ºæ¸ˆã¿ãªã®ã§p.then(logB)ã‚’å³å®Ÿè¡Œã€‚
  // logã‚‚å®Ÿè¡Œå¾Œ logC ã‚’è¡¨ç¤ºã€‚
  // 
  // å›³è§£:
  //  wait1
  // |-----|
  //       logA
  //       |-|
  //       wait2
  //       |----------|
  //                ã€€logB
  //                ã€€|-|
  //      ã€€ã€€ã€€        logC
  //ã€€ã€€ã€€              |-|  const p = wait1().then(logA);
  wait2()
    .then(() => {
      return p.then(logB);
    })
    .then(logC);
}

function f8() {
  // NOTE: f9, f10 ã¨ã®æ¯”è¼ƒç”¨
  // èª¬æ˜Žï¼š
  // 1ç§’å¾Œã«X ã‚’è¡¨ç¤ºã€å³ logA ã‚’è¡¨ç¤º
  // 
  // wait1 ã§1ç§’å¾…æ©Ÿå¾Œã« errX ã‚’å®Ÿè¡Œã€‚throwã§catchãƒ–ãƒ­ãƒƒã‚¯ã«ã‚¨ãƒ©ãƒ¼ã‚’æ¸¡ã™ã€‚.then(errY)ã¯å®Ÿè¡Œã—ãªã„
  // catch ã‚’å®Ÿè¡Œã€‚æ¸¡ã•ã‚ŒãŸ X ã‚’consoleã§è¡¨ç¤º
  // catchå®Ÿè¡Œå¾Œã€finallyã‚’å®Ÿè¡Œã§logAã‚’è¡¨ç¤º
  // 
  // å›³è§£:
  //  wait1
  // |-----|
  //       errX
  //       |-|
  //         catch
  //       ã€€|-|
  //      ã€€ã€€ã€€finally
  //ã€€ã€€ã€€      |-|
  //      ã€€ã€€ã€€  logA
  //ã€€ã€€ã€€        |-|
    .then(errX)
    .then(errY)
    .catch((e) => log(e.message))
    .finally(logA);
}

function f9() {
  // NOTE: f12 ã¨ã®æ¯”è¼ƒç”¨
  // èª¬æ˜Žï¼š
  // 1ç§’å¾Œã«Yã‚’è¡¨ç¤ºã€logAè¡¨ç¤º
  // wait1ã‚’1ç§’å¾Œã«è§£æ±ºã—,thenãƒ–ãƒ­ãƒƒã‚¯ãŒ42ã‚’è¿”ã™ã€‚
  // æ¬¡ã®thenã§errYã‚’ã‚¹ãƒ­ãƒ¼ã—Yã‚’é€ã‚‹
  // catchã‚’å®Ÿè¡Œã€€æ¸¡ã•ã‚ŒãŸYã‚’è¡¨ç¤º
  // finallyã‚’å®Ÿè¡Œã—Aã‚’è¡¨ç¤º
  // 
  // å›³è§£:
  //  wait1
  // |-----|
  //       thenã€€42
  //       |-|
  //         errY
  //       ã€€|-|
  //      ã€€ã€€  catch
  //ã€€ã€€ã€€      |-|
  //      ã€€ã€€  ã€€Y
  //ã€€ã€€ã€€        |-|
  //      ã€€ã€€ã€€    finally
  //ã€€ã€€ã€€          |-|
  //      ã€€ã€€ã€€      logA
  //ã€€ã€€ã€€            |-|
  wait1()
    .then(() => 42)
    .then(errY)
    .catch((e) => log(e.message))
    .finally(logA);
}

function f10() {
  // NOTE: then(r, c) ã¨ then(r).catch(c) ã¯ç­‰ã—ã„ã‹ï¼Ÿ
  // then(r, c)ã€€ã€€ã€€ã€€ ç‰¹å®šã® .then ã§ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼ã®ã¿ã‚’å‡¦ç†ã™ã‚‹
  // then(r).catch(c)ã€€ å‰ã®å…¨ã¦ã® .then ãƒã‚§ãƒ¼ãƒ³ã§ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†ã™ã‚‹

  // èª¬æ˜Žï¼š
  // wait1ã‚’1ç§’å¾Œã«è§£æ±ºã—,thenãƒ–ãƒ­ãƒƒã‚¯ãŒ42ã‚’è¿”ã™ã€‚
  // æ¬¡ã®thenã§errYã‚’ã‚¹ãƒ­ãƒ¼ã—Yã‚’é€ã‚‹ã€‚ã‚¨ãƒ©ãƒ¼ãªã®ã§ç¬¬äºŒå¼•æ•° (e) => log(e.message) ã¯ç„¡è¦–
  // catchãŒãªã„ãŸã‚finallyã«ã‚’å®Ÿè¡Œã—Aã‚’è¡¨ç¤º
  // 
  // å›³è§£:
  //  wait1
  // |-----|
  //       thenã€€42
  //       |-|
  //         errY
  //       ã€€|-|
  //           Y
  //       ã€€  |-|
  //      ã€€ã€€  ã€€finally
  //ã€€ã€€ã€€        |-|
  //      ã€€ã€€ã€€    logA
  //ã€€ã€€ã€€          |-|
  wait1()
    .then(() => 42)
    .then(errY, (e) => log(e.message))
    .finally(logA);
}

function f11() {
  // f12 ã¨ã®æ¯”è¼ƒç”¨: new Promise å†…ã® throw ã¯ .catch ã§ã‚­ãƒ£ãƒƒãƒã§ãã‚‹ã‹ï¼Ÿ
  // èª¬æ˜Žï¼š
  // new Promiseã‚’ä½œã‚Šå³å®Ÿè¡Œã€‚promiseå†…ã®errXã‚’å‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼ã—catchã¸
  // æ¸¡ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆXã‚’è¡¨ç¤º
  // 
  // å›³è§£:
  //  new Promise
  // |-----|
  //       errX()
  //       |-|
  //         throw Error(X)
  //       ã€€|-|
  //      ã€€ã€€  .catch 
  //ã€€ã€€ã€€      |-|
  //      ã€€ã€€  ã€€e.message X
  //ã€€ã€€ã€€        |-|

  new Promise((resolve, reject) => {
    errX();
  }).catch((e) => log(e.message));
}

function f12() {
  // new Promise å†…ã ãŒã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã§ throw ã—ãŸå ´åˆã¯ï¼Ÿ
  // new Promise å†…ã§ setTimeout ãŒè¨­å®šã•ã‚Œã€0ãƒŸãƒªç§’å¾Œã« errX ãŒå®Ÿè¡Œ
  // Xã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹ãŒcatchã«å¤±æ•—ã€‚promiseã®å¤–ï¼ˆsetTimeoutå†…ã§ã‚¨ãƒ©ãƒ¼ï¼‰ã§ã§ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼ã¯Promiseäº‹æ…‹ã§ã¯catchã•ã‚Œãšã«ã‚¨ãƒ©ãƒ¼æ–‡ã‚’è¡¨ç¤ºã™ã‚‹
  // â†’éžåŒæœŸé–¢æ•°å†…ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‚‰é€šå¸¸ã®try/catchã§ã¯ã‚­ãƒ£ãƒƒãƒã§ããªã„
  // èª¬æ˜Žï¼š
  // new Promiseã‚’ä½œã‚Šå³å®Ÿè¡Œã€‚
  // setTimeoutã®ç¬¬äºŒå¼•æ•°ãŒ0ãªã®ã§ã€() => errX()ã‚’å³å®Ÿè¡Œã€‚
  // catchã¸ã‚¹ãƒ­ãƒ¼ã—Xã‚’æ¸¡ã™ã€‚
  // 
  // å›³è§£:
  //  new Promise
  // |-----|
  //       setTimeoutã€€0
  //       |-|
  //         errX()
  //       ã€€|-|
  //      ã€€ã€€  .catch ã‚¨ãƒ©ãƒ¼
  //ã€€ã€€ã€€      |-|
  new Promise((resolve, reject) => {
    setTimeout(() => errX(), 0);
  }).catch((e) => log(e.message));
}
```

**å‡ºé¡Œç¯„å›²**: 13.2